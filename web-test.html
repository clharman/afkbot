<!DOCTYPE html>
<html>
<head>
  <title>Snowfort Web Test</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f0f1a;
      color: #fff;
      margin: 0;
      padding: 20px;
    }
    .container { max-width: 800px; margin: 0 auto; }
    h1 { color: #6366f1; }
    .status {
      padding: 8px 16px;
      border-radius: 4px;
      display: inline-block;
      margin-bottom: 20px;
    }
    .connected { background: #22c55e; }
    .disconnected { background: #ef4444; }
    .sessions { margin: 20px 0; }
    .session {
      background: #1a1a2e;
      border: 1px solid #2a2a4a;
      border-radius: 8px;
      padding: 16px;
      margin: 10px 0;
      cursor: pointer;
    }
    .session:hover { border-color: #6366f1; }
    .session h3 { margin: 0 0 8px 0; }
    .session p { margin: 0; color: #9ca3af; font-size: 14px; }
    .output {
      background: #000;
      border-radius: 8px;
      padding: 16px;
      font-family: monospace;
      font-size: 14px;
      height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      margin: 20px 0;
    }
    .input-row { display: flex; gap: 10px; }
    input, button {
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid #2a2a4a;
      font-size: 16px;
    }
    input {
      flex: 1;
      background: #1a1a2e;
      color: #fff;
    }
    button {
      background: #6366f1;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover { background: #4f46e5; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .back { background: #374151; margin-bottom: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Snowfort</h1>
    <div id="status" class="status disconnected">Disconnected</div>

    <div id="login-view">
      <h2>Connect</h2>
      <div class="input-row" style="margin-bottom: 10px;">
        <input type="text" id="server" value="ws://localhost:8080" placeholder="Server URL">
      </div>
      <div class="input-row">
        <input type="text" id="token" value="test-token-123" placeholder="Token">
        <button onclick="connect()">Connect</button>
      </div>
    </div>

    <div id="sessions-view" style="display: none;">
      <h2>Sessions</h2>
      <div id="sessions" class="sessions">
        <p style="color: #9ca3af;">No sessions</p>
      </div>
    </div>

    <div id="session-view" style="display: none;">
      <button class="back" onclick="backToSessions()">Back</button>
      <h2 id="session-title">Session</h2>
      <div id="output" class="output"></div>
      <div class="input-row">
        <input type="text" id="message" placeholder="Send a message..." onkeypress="if(event.key==='Enter')sendMessage()">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <script>
    let ws = null;
    let currentSession = null;
    let sessions = [];

    function connect() {
      const server = document.getElementById('server').value;
      const token = document.getElementById('token').value;

      ws = new WebSocket(server + '/ws/mobile');

      ws.onopen = () => {
        console.log('Connected');
        ws.send(JSON.stringify({ type: 'auth', token }));
      };

      ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        console.log('Received:', msg);
        handleMessage(msg);
      };

      ws.onclose = () => {
        document.getElementById('status').textContent = 'Disconnected';
        document.getElementById('status').className = 'status disconnected';
      };

      ws.onerror = (err) => {
        console.error('WebSocket error:', err);
        alert('Connection failed');
      };
    }

    function handleMessage(msg) {
      switch (msg.type) {
        case 'auth_ok':
          document.getElementById('status').textContent = 'Connected';
          document.getElementById('status').className = 'status connected';
          document.getElementById('login-view').style.display = 'none';
          document.getElementById('sessions-view').style.display = 'block';
          ws.send(JSON.stringify({ type: 'list_sessions' }));
          break;

        case 'auth_error':
          alert('Auth failed: ' + msg.message);
          break;

        case 'sessions_list':
          sessions = msg.sessions;
          renderSessions();
          break;

        case 'session_output':
          if (msg.sessionId === currentSession) {
            const output = document.getElementById('output');
            output.textContent += msg.data;
            output.scrollTop = output.scrollHeight;
          }
          break;

        case 'session_status':
          const session = sessions.find(s => s.id === msg.sessionId);
          if (session) session.status = msg.status;
          renderSessions();
          break;
      }
    }

    function renderSessions() {
      const container = document.getElementById('sessions');
      if (sessions.length === 0) {
        container.innerHTML = '<p style="color: #9ca3af;">No sessions</p>';
        return;
      }

      container.innerHTML = sessions.map(s => `
        <div class="session" onclick="openSession('${s.id}')">
          <h3>${s.name || s.id}</h3>
          <p>${s.cwd} - ${s.status}</p>
        </div>
      `).join('');
    }

    function openSession(id) {
      currentSession = id;
      const session = sessions.find(s => s.id === id);
      document.getElementById('session-title').textContent = session?.name || id;
      document.getElementById('output').textContent = '';
      document.getElementById('sessions-view').style.display = 'none';
      document.getElementById('session-view').style.display = 'block';
      ws.send(JSON.stringify({ type: 'subscribe', sessionId: id }));
    }

    function backToSessions() {
      if (currentSession) {
        ws.send(JSON.stringify({ type: 'unsubscribe', sessionId: currentSession }));
      }
      currentSession = null;
      document.getElementById('session-view').style.display = 'none';
      document.getElementById('sessions-view').style.display = 'block';
      ws.send(JSON.stringify({ type: 'list_sessions' }));
    }

    function sendMessage() {
      const input = document.getElementById('message');
      const text = input.value.trim();
      if (!text || !currentSession) return;

      ws.send(JSON.stringify({
        type: 'send_input',
        sessionId: currentSession,
        text
      }));
      input.value = '';
    }
  </script>
</body>
</html>
